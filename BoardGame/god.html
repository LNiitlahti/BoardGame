<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>God Mode - Board Game Admin</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
    <link rel="manifest" href="images/favicon/site.webmanifest">
    <link rel="shortcut icon" href="images/favicon/favicon.ico">

    <link rel="stylesheet" href="css/brand-theme.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/god_styles.css">
</head>
<body>
    <div id="connectionStatus" class="connection-status disconnected" title="Firebase: Connecting..."></div>

    <div class="container">
        <div class="header" style="padding: 12px 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="images/favicon/android-chrome-512x512.png" alt="Brand Logo" class="brand-logo small">
                    <div>
                        <h1 style="margin: 0; font-size: 1.5rem; color: #f7f0e3 !important; background: none !important; -webkit-text-fill-color: #f7f0e3 !important;">
                            <span id="brandName">BoardGame</span> | 👑 God Mode
                        </h1>
                        <div id="currentTournamentIndicator" style="font-size: 0.75rem; color: #ffd700; margin-top: 4px; display: none;">
                            <span style="opacity: 0.7;">🏆 Tournament:</span> <strong id="currentTournamentName">None</strong>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="goBackToHome()" style="width: auto; padding: 6px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);">
                    ⬅️ Home
                </button>
            </div>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <!-- Main Navigation Tabs -->
        <nav class="god-nav">
            <button class="god-nav-tab active" data-tab="tournaments" onclick="switchGodTab('tournaments')">
                🏆 Tournaments
            </button>
            <button class="god-nav-tab" data-tab="matches" onclick="switchGodTab('matches')">
                🎮 Matches
            </button>
            <button class="god-nav-tab" data-tab="board" onclick="switchGodTab('board')">
                🎯 Board
            </button>
            <button class="god-nav-tab" data-tab="teams" onclick="switchGodTab('teams')">
                👥 Teams
            </button>
            <button class="god-nav-tab" data-tab="users" onclick="switchGodTab('users')">
                👤 Users
            </button>
            <button class="god-nav-tab" data-tab="spells" onclick="switchGodTab('spells')">
                🔮 Spells
            </button>
            <button class="god-nav-tab" data-tab="stats" onclick="switchGodTab('stats')">
                📊 Stats
            </button>
        </nav>

        <!-- Tab 1: Tournaments Panel -->
        <div id="tournamentsPanel" class="god-tab-panel active">
            <!-- Tournament Management Panel (moved from left sidebar) -->
            <div class="panel">
                <h3>🏆 Tournament Management</h3>

                <!-- Statistics -->
                <div class="tournament-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(6, 182, 212, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #06b6d4;" id="totalTournaments">0</div>
                        <div style="font-size: 0.85rem; color: #94a3b8;">Total Tournaments</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="activeTournaments">0</div>
                        <div style="font-size: 0.85rem; color: #94a3b8;">Active</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #a855f7;" id="finishedTournaments">0</div>
                        <div style="font-size: 0.85rem; color: #94a3b8;">Finished</div>
                    </div>
                </div>

                <!-- Search -->
                <div class="form-group" style="margin-bottom: 10px;">
                    <input type="text" id="tournamentSearch" placeholder="🔍 Search tournaments..."
                           oninput="filterTournaments()"
                           style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white; font-size: 1rem;">
                </div>

                <!-- Filter & Create -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select id="statusFilter" onchange="filterTournaments()" style="flex: 1; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                        <option value="all">All Status</option>
                        <option value="setup">Setup</option>
                        <option value="playing">Playing</option>
                        <option value="finished">Finished</option>
                        <option value="archived">Archived</option>
                    </select>
                    <button class="btn primary" onclick="createNewTournament()" style="white-space: nowrap;" data-tooltip="Create a new tournament with custom settings">
                        ➕ Create New
                    </button>
                </div>

                <!-- Tournament List -->
                <div id="tournamentList" style="max-height: 600px; overflow-y: auto;">
                    <p style="text-align: center; opacity: 0.7;">Loading tournaments...</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: Matches Panel -->
        <div id="matchesPanel" class="god-tab-panel">
            <div style="max-width: 900px; margin: 0 auto;">
            <!-- Match Controls -->
            <div>
                <!-- Match Queue Manager -->
                <div class="panel">
                    <h3>📋 Match Queue Manager</h3>
                    <div class="form-group">
                        <label>Game ID</label>
                        <input type="text" id="gameId" placeholder="tournament-id">
                        <button class="btn" onclick="loadGame()" style="margin-top: 5px;" data-tooltip="Load tournament data to manage matches">📂 Load Game</button>
                    </div>

                    <!-- Template Display -->
                    <div id="templateDisplay" style="margin-top: 15px;">
                        <p style="text-align: center; opacity: 0.7;">Load a game to see templates</p>
                    </div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h3>🎯 Game Management</h3>
                    
                    <!-- Tab Buttons -->
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('plan')">📋 Plan Game</button>
                        <button class="tab-btn" onclick="switchTab('confirm')">✅ Confirm Result</button>
                    </div>

                    <!-- Plan Game Tab -->
                    <div id="planTab" class="tab-content active">
                        <div class="form-group">
                            <label>Game Type</label>
                            <select id="planGameType">
                                <option value="CS2">Counter-Strike 2</option>
                                <option value="Dota2">Dota 2</option>
                                <option value="Valorant">Valorant</option>
                                <option value="StarCraft2">StarCraft 2</option>
                                <option value="Predecessor">Predecessor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Match Type</label>
                            <select id="planPlayType">
                                <option value="1v1">1v1</option>
                                <option value="2v2">2v2</option>
                                <option value="3v3">3v3</option>
                                <option value="5v5">5v5</option>
                            </select>
                        </div>

                        <label style="color: #ffd700; font-weight: 600; display: block; margin-bottom: 10px;">
                            Build Match (drag players or whole teams)
                        </label>

                        <!-- Player-based drag and drop -->
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div class="player-drop-zone team-a" 
                                     ondrop="dropPlayer(event, 'teamA')" 
                                     ondragover="allowDrop(event)" 
                                     ondragleave="dragLeave(event)">
                                    <h5 style="color: #3b82f6; margin-bottom: 8px;">TEAM A</h5>
                                    <div id="teamAPlayers" style="min-height: 60px;">
                                        <span style="opacity: 0.6; font-size: 0.85rem;">Drop players here...</span>
                                    </div>
                                </div>
                            </div>

                            <div style="flex: 1;">
                                <div class="player-drop-zone team-b" 
                                     ondrop="dropPlayer(event, 'teamB')" 
                                     ondragover="allowDrop(event)" 
                                     ondragleave="dragLeave(event)">
                                    <h5 style="color: #ef4444; margin-bottom: 8px;">TEAM B</h5>
                                    <div id="teamBPlayers" style="min-height: 60px;">
                                        <span style="opacity: 0.6; font-size: 0.85rem;">Drop players here...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Available teams/players pool -->
                        <div class="team-pool" style="max-height: 300px;">
                            <h4>Available Teams & Players</h4>
                            <div id="planTeamPool"></div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>Notes (optional)</label>
                            <input type="text" id="planNotes" placeholder="Any special notes about this game...">
                        </div>
                        <button class="btn primary" onclick="addGameToQueue()" data-tooltip="Add this match to the queue for play">➕ Add to Queue</button>
                        <button class="btn" onclick="clearManualGameSetup()" data-tooltip="Clear all players from both teams">🔄 Clear</button>
                    </div>

                    <!-- Confirm Result Tab -->
                    <div id="confirmTab" class="tab-content">
                        <div class="form-group">
                            <label>Select Queued Game</label>
                            <select id="queuedGameSelect" onchange="loadQueuedGame(parseInt(this.value))">
                                <option value="">-- Select a game to confirm --</option>
                            </select>
                        </div>

                        <div class="confirm-container" id="confirmContainer" style="display: none;">
                            <h4 style="color: #ffd700; margin-bottom: 10px;">Game Details</h4>
                            <div id="confirmGameInfo"></div>

                            <h4 style="color: #ffd700; margin-top: 15px; margin-bottom: 10px;">Select Winner(s)</h4>
                            <div id="confirmTeamsDisplay"></div>

                            <div class="form-group" style="margin-top: 15px;">
                                <label>Actual Result Notes (optional)</label>
                                <input type="text" id="confirmNotes" placeholder="Any additional notes about the result...">
                            </div>

                            <button class="btn primary" onclick="confirmGameResult()" data-tooltip="Confirm match outcome and begin tile placement phase">✅ Submit Result & Start Turn</button>
                        </div>
                    </div>
                </div>

                <!-- Game Queue Display -->
                <div class="panel" style="margin-top: 20px;">
                    <h3>📋 Game Queue (<span id="queueCount">0</span>)</h3>
                    <div class="queue-container" id="gameQueue">
                        <p style="text-align: center; opacity: 0.7; font-style: italic;">No games in queue</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: Board Panel -->
    <div id="boardPanel" class="god-tab-panel">
        <div class="board-layout">
            <div class="panel" style="width: 100%;">
                <h3 style="text-align: center;">🎯 Game Board</h3>
                <div id="currentTurnInfoBoard" style="text-align: center; padding: 15px; background: rgba(255, 215, 0, 0.2); border-radius: 10px; margin: 15px 0;">
                    <strong>⏳ No active turn</strong>
                </div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <button class="btn" id="undoBtn" onclick="undoAction()" disabled style="width: auto; display: inline-block; margin: 5px;" data-tooltip="Undo the last action (tile placement, spell cast, etc.)">
                        ⬅️ Undo
                    </button>
                    <button class="btn" id="redoBtn" onclick="redoAction()" disabled style="width: auto; display: inline-block; margin: 5px;" data-tooltip="Redo the previously undone action">
                        ➡️ Redo
                    </button>
                    <span id="actionHistoryStatus" style="margin-left: 10px; opacity: 0.7; font-size: 0.9rem;">No actions yet</span>
                </div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <button class="btn" onclick="highlightValidPlacements()" style="width: auto; display: inline-block; margin: 5px;" data-tooltip="Highlight all hexes where the current team can place tiles">
                        🔍 Show Valid Placements
                    </button>
                    <button class="btn" onclick="clearHighlights()" style="width: auto; display: inline-block; margin: 5px;" data-tooltip="Remove all highlights from the board">
                        🧹 Clear Highlights
                    </button>
                </div>
            </div>

            <div class="hex-board-wrapper" style="margin: 20px 0;">
                <div id="hexBoardAlt"></div>
            </div>

            <div class="panel" style="width: 100%; margin-top: 20px;">
                <h4 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleActionHistory()">
                    📜 Action History
                    <span id="actionHistoryToggle">▼</span>
                </h4>
                <div id="actionHistoryPanel" style="display: none; max-height: 300px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); padding: 10px; border-radius: 8px; margin-top: 10px;">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">No actions yet</p>
                </div>
            </div>

            <div class="panel" style="width: 100%;">
                <h4 style="margin-bottom: 15px;">Board Legend</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.85rem;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 18px; background: rgba(255, 215, 0, 0.5); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></div>
                        Starting Corner
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 18px; background: rgba(255, 20, 147, 0.5); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></div>
                        Heart Hex (+1/turn)
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 18px; background: rgba(138, 43, 226, 0.5); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></div>
                        Mountain Heart (+2/turn)
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 18px; background: rgba(0, 255, 0, 0.4); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></div>
                        Can Place Here
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 4: Teams Panel -->
    <div id="teamsPanel" class="god-tab-panel">
        <!-- User Appointment Section -->
        <div class="panel" style="margin-bottom: 20px;">
            <h3>👤 User Appointment</h3>
            <p style="opacity: 0.7; margin-bottom: 15px;">Assign registered users to teams in the loaded tournament</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Unassigned Users -->
                <div>
                    <h4 style="color: #06b6d4; margin-bottom: 10px;">📋 Unassigned Users</h4>
                    <div id="unassignedUsersList" style="max-height: 500px; overflow-y: auto; background: rgba(15, 23, 42, 0.3); padding: 10px; border-radius: 8px;">
                        <p style="text-align: center; opacity: 0.5;">Load a tournament first</p>
                    </div>
                    <button class="btn" onclick="loadUnassignedUsers()" style="width: 100%; margin-top: 10px;" data-tooltip="Reload the list of registered users who aren't assigned to teams">
                        🔄 Refresh Users List
                    </button>
                </div>

                <!-- Team Assignment Slots -->
                <div>
                    <h4 style="color: #10b981; margin-bottom: 10px;">🎯 Assign to Teams</h4>
                    <div id="teamAssignmentSlots" style="max-height: 500px; overflow-y: auto;">
                        <p style="text-align: center; opacity: 0.5;">Load a tournament to see teams</p>
                    </div>
                    <button class="btn primary" onclick="saveUserAppointments()" style="width: 100%; margin-top: 10px;" data-tooltip="Save all user-to-team assignments to the tournament">
                        💾 Save All Appointments
                    </button>
                </div>
            </div>
        </div>

        <!-- Tournament Roster Overview -->
        <div class="panel">
            <h3>📋 Tournament Roster</h3>
            <p style="opacity: 0.7; margin-bottom: 15px;">All teams and their assigned players</p>
            <div id="tournamentRosterDisplay" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                <p style="text-align: center; opacity: 0.5; grid-column: 1 / -1;">Load a tournament to see roster</p>
            </div>
        </div>
    </div>

    <!-- Tab 5: Stats Panel -->
    <div id="statsPanel" class="god-tab-panel">
        <div class="panel">
            <h3>📊 Game Statistics</h3>
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #06b6d4;" id="statGamesPlayedBig">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Games Played</div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #10b981;" id="statRoundBig">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Current Round</div>
                </div>
                <div style="background: rgba(168, 85, 247, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #a855f7;" id="statPlatesBig">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Plates on Board</div>
                </div>
                <div style="background: rgba(244, 63, 94, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #f43f5e;" id="statHeartsBig">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Hearts Controlled</div>
                </div>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">
            <h3>👥 Team Rankings</h3>
            <div id="teamsListStats">
                <p style="text-align: center; opacity: 0.7; font-style: italic;">Initialize game to see teams</p>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">
            <h3>📜 Match History</h3>
            <div id="matchHistoryLog" style="max-height: 400px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 10px;">
                <p style="text-align: center; opacity: 0.7;">No match history yet</p>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">
            <h3>💾 Data Management</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="exportGameState()">📥 Export Game State</button>
                <button class="btn" onclick="saveGameState()">💾 Save to Firebase</button>
                <button class="btn" onclick="clearLog()">🗑️ Clear Game Log</button>
                <button class="btn secondary" onclick="loadBackup()">📂 Load Backup</button>
            </div>
        </div>
    </div>

    <!-- Tab 6: Spells Panel -->
    <div id="spellsPanel" class="god-tab-panel">
        <div class="panel">
            <h3>🔮 Spell Card Management</h3>

            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(168, 85, 247, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #a855f7;" id="totalSpellsDef">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Spell Definitions</div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #10b981;" id="totalSpellsHeld">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">In Team Hands</div>
                </div>
                <div style="background: rgba(244, 63, 94, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #f43f5e;" id="totalSpellsCast">0</div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">Spells Cast</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="loadAllSpells()" style="flex: 1;"
                        data-tooltip="Load all 15 spell cards from Firebase">
                    📥 Load Spell Definitions
                </button>
                <button class="btn secondary" onclick="window.open('upload-spells.html', '_blank')" style="flex: 1;"
                        data-tooltip="Open spell upload utility in new tab">
                    ⬆️ Upload Spells
                </button>
            </div>
        </div>

        <!-- Team Spell Distribution -->
        <div class="panel" style="margin-top: 20px;">
            <h3>📦 Distribute Spells to Teams</h3>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
                Select a team and spell cards to add to their hand
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Team Selection -->
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.9rem;">Select Team:</label>
                    <select id="spellDistTeam" onchange="updateTeamSpellInventory()"
                            style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                        <option value="">-- Choose Team --</option>
                    </select>

                    <div id="teamCurrentSpells" style="margin-top: 15px; padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; min-height: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: #00d4ff; font-size: 0.9rem;">Current Spells:</h4>
                        <div id="teamSpellsList">
                            <p style="opacity: 0.5; font-size: 0.85rem;">Select a team to view</p>
                        </div>
                    </div>
                </div>

                <!-- Spell Selection -->
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.9rem;">Select Spell to Add:</label>
                    <select id="spellToDistribute"
                            style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white; margin-bottom: 10px;">
                        <option value="">-- Choose Spell --</option>
                    </select>

                    <div id="spellPreview" style="margin-bottom: 15px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; min-height: 150px; display: none;">
                        <!-- Spell preview will be shown here -->
                    </div>

                    <button class="btn" onclick="distributeSpellToTeam()" id="distributeBtn" disabled
                            style="width: 100%; background: #a855f7; margin-bottom: 10px;"
                            data-tooltip="Add selected spell to selected team's hand">
                        ➕ Add Spell to Team
                    </button>

                    <button class="btn secondary" onclick="distributeRandomSpells()"
                            style="width: 100%;"
                            data-tooltip="Give random spells to all teams (you choose how many)">
                        🎲 Distribute Random Spells
                    </button>
                </div>
            </div>
        </div>

        <!-- Available Spells Library -->
        <div class="panel" style="margin-top: 20px;">
            <h3>📚 Available Spell Cards</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="spellSearchInput" placeholder="🔍 Search spells..."
                       oninput="filterSpells()"
                       style="flex: 1; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                <select id="spellTypeFilter" onchange="filterSpells()"
                        style="padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                    <option value="all">All Types</option>
                    <option value="pre-game">Pre-Game</option>
                    <option value="instant">Instant</option>
                    <option value="tactical">Tactical</option>
                    <option value="defensive">Defensive</option>
                    <option value="aggressive">Aggressive</option>
                    <option value="rare">Rare</option>
                </select>
            </div>

            <div id="spellsLibrary" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 600px; overflow-y: auto;">
                <p style="text-align: center; opacity: 0.7; padding: 40px; grid-column: 1/-1;">
                    Click "Load Spell Definitions" to view available spells
                </p>
            </div>
        </div>

        <!-- Spell Usage History -->
        <div class="panel" style="margin-top: 20px;">
            <h3>📜 Spell Cast History</h3>
            <div id="spellHistory" style="max-height: 400px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 10px;">
                <p style="text-align: center; opacity: 0.7;">No spells cast yet</p>
            </div>
        </div>
    </div>

    <!-- Tab 7: Users Panel -->
    <div id="usersPanel" class="god-tab-panel">
        <div class="panel">
            <h3>👤 User Management</h3>

            <!-- Statistics -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                <div style="background: rgba(6, 182, 212, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #06b6d4;" id="totalUsersCount">0</div>
                    <div style="font-size: 0.85rem; color: #94a3b8;">Total Users</div>
                </div>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #ffd700;" id="godCount">0</div>
                    <div style="font-size: 0.85rem; color: #94a3b8;">Gods</div>
                </div>
                <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="adminCount">0</div>
                    <div style="font-size: 0.85rem; color: #94a3b8;">Admins</div>
                </div>
                <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #00d4ff;" id="playerCount">0</div>
                    <div style="font-size: 0.85rem; color: #94a3b8;">Players</div>
                </div>
            </div>

            <!-- Search & Filter -->
            <div style="display: grid; grid-template-columns: 1fr 200px 150px; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="userSearch" placeholder="🔍 Search by name, email, or UID..."
                       oninput="filterUsers()"
                       style="padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white; font-size: 1rem;">
                <select id="roleFilter" onchange="filterUsers()"
                        style="padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                    <option value="all">All Roles</option>
                    <option value="god">God</option>
                    <option value="admin">Admin</option>
                    <option value="player">Player</option>
                    <option value="user">User</option>
                </select>
                <button class="btn primary" onclick="showCreateUserModal()" style="white-space: nowrap;">
                    ➕ Create User
                </button>
            </div>

            <!-- User Table -->
            <div style="max-height: 600px; overflow-y: auto;">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; opacity: 0.7;">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Tournament Modal -->
    <div id="editTournamentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>✏️ Edit Tournament</h2>
                <button onclick="closeEditModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
            <div class="modal-body" id="editTournamentForm">
                <!-- Form will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="userModalTitle">➕ Create User</h2>
                <button onclick="closeUserModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="userFormUid" value="">

                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="userFormEmail" required
                               style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                    </div>

                    <div class="form-group">
                        <label>Display Name *</label>
                        <input type="text" id="userFormDisplayName" required
                               style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                    </div>

                    <div class="form-group" id="passwordGroup">
                        <label>Password *</label>
                        <input type="password" id="userFormPassword" required
                               minlength="6"
                               placeholder="Minimum 6 characters"
                               style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">Minimum 6 characters</small>
                    </div>

                    <div class="form-group">
                        <label>Role *</label>
                        <select id="userFormRole" required
                                style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 8px; color: white;">
                            <option value="user">User (Default)</option>
                            <option value="player">Player</option>
                            <option value="admin">Admin</option>
                            <option value="god">God (Full Access)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="userFormEnabled" checked>
                            Account Enabled
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn secondary" onclick="closeUserModal()">Cancel</button>
                        <button type="submit" class="btn primary">Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hidden elements for data storage (populated by JS, synced to visible panels) -->
    <div style="display: none;">
        <div id="teamsList"></div>
        <div id="playersList"></div>
        <div id="statGamesPlayed">0</div>
        <div id="statRound">0</div>
        <div id="statPlates">0</div>
        <div id="statHearts">0</div>
    </div>

    <!-- Game Log Footer -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); border-top: 2px solid rgba(255, 215, 0, 0.3); z-index: 100; backdrop-filter: blur(10px);">
        <div style="padding: 8px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;" onclick="toggleGameLogFooter()">
            <h4 style="margin: 0; color: #ffd700; font-size: 0.9rem;">📜 Game Log</h4>
            <span id="gameLogToggleIcon" style="color: #ffd700; font-size: 1.2rem;">▲</span>
        </div>
        <div id="gameLogFooterContent" style="max-height: 200px; overflow-y: auto; padding: 10px 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="game-log" id="gameLog">
                <div class="log-entry">System initialized. Ready to start.</div>
            </div>
        </div>
    </div>

    <!-- Load infrastructure first -->
    <script type="module" src="scripts/errorHandler.js"></script>
    <script type="module" src="scripts/stateManager.js"></script>
    <script type="module" src="scripts/utils.js"></script>

    <!-- Load board modules -->
    <script src="scripts/board-module.js"></script>
    <script src="scripts/board-renderer.js"></script>

    <!-- Firebase SDK - Using the loader pattern -->
    <script src="scripts/firebase-loader.js"></script>

    <!-- Load action history system -->
    <script src="scripts/action-history.js"></script>

    <!-- Load tournament management module -->
    <script src="scripts/tournament-manager.js"></script>

    <!-- Load all god mode functionality -->
    <script src="scripts/spell-manager.js"></script>
    <script src="scripts/god-scripts.js"></script>
    <script src="scripts/spells-god.js"></script>

    <!-- Load user management -->
    <script src="scripts/user-management.js"></script>

    <!-- Authentication & Navigation Integration -->
    <script>
        // =============================================================================
        // APPLICATION CONFIGURATION
        // =============================================================================
        /**
         * Application Configuration
         * Change BRAND_NAME to customize the branding across the application
         */
        const BRAND_NAME = 'BoardGame';  // ← Change this to your brand name

        // Apply brand name on page load
        window.addEventListener('DOMContentLoaded', () => {
            const brandElement = document.getElementById('brandName');
            if (brandElement) {
                brandElement.textContent = BRAND_NAME;
            }
        });

        // =============================================================================
        // AUTHENTICATION & SECURITY
        // =============================================================================
        /**
         * Check authentication and role before allowing access
         * GOD/ADMIN only page
         *
         * NOTE: This is a CLIENT-SIDE check only for UX purposes.
         * Real security is enforced by Firestore Security Rules server-side.
         * If users bypass this check, they still won't be able to read/write data.
         */
        document.addEventListener('firebase-ready', function() {
            const auth = firebase.auth();

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not logged in → redirect to login
                    console.log('[God Mode] Not authenticated, redirecting to login...');
                    alert('You must be logged in to access this page');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('[God Mode] User authenticated:', user.uid);

                // Try to get role from session storage first (set by index.html router)
                const userRole = sessionStorage.getItem('userRole');

                if (userRole === 'god' || userRole === 'admin') {
                    console.log('[God Mode] Access granted via session role:', userRole);
                    return; // Allow access
                }

                // If no session role, try Firestore as backup
                // This is just for UX - real security is in Firestore rules
                try {
                    const db = firebase.firestore();

                    // Try to read user document - if rules block it, user isn't admin
                    const userDoc = await db.collection('users').doc(user.uid).get();

                    if (!userDoc.exists()) {
                        console.log('[God Mode] No user profile found');
                        // Let them try - if they're not admin, Firestore rules will block operations
                        console.log('[God Mode] Allowing access - Firestore rules will enforce permissions');
                        return;
                    }

                    const userData = userDoc.data();
                    const isAuthorized = userData.isGod === true ||
                                       userData.isAdmin === true;

                    if (isAuthorized) {
                        console.log('[God Mode] Access granted via Firestore document');
                        // Update session storage for next time
                        sessionStorage.setItem('userRole', 'god');
                    } else {
                        console.log('[God Mode] User not in admin list, but allowing access');
                        console.log('[God Mode] Firestore rules will block unauthorized operations');
                        // Don't redirect - let Firestore rules handle security
                        // If they try to do something unauthorized, they'll get permission errors
                    }
                } catch (error) {
                    console.error('[God Mode] Error checking permissions:', error);
                    // Don't redirect on error - Firestore rules will handle security
                    console.log('[God Mode] Allowing access despite error - Firestore rules will enforce permissions');

                    // Show a warning to user
                    const statusEl = document.getElementById('statusMessage');
                    if (statusEl) {
                        statusEl.textContent = 'Note: Could not verify admin status. Some features may be restricted by server permissions.';
                        statusEl.style.background = 'rgba(234, 179, 8, 0.2)';
                        statusEl.style.borderColor = '#eab308';
                        statusEl.style.display = 'block';
                    }
                }
            });
        });

        /**
         * Navigate back to home dashboard
         */
        function goBackToHome() {
            window.location.href = 'home.html';
        }

        /**
         * Update the current tournament indicator in the header
         */
        function updateTournamentIndicator(tournamentId, tournamentName) {
            const indicator = document.getElementById('currentTournamentIndicator');
            const nameSpan = document.getElementById('currentTournamentName');

            if (tournamentId && tournamentName) {
                nameSpan.textContent = tournamentName;
                indicator.style.display = 'block';
            } else if (tournamentId) {
                nameSpan.textContent = tournamentId;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        /**
         * Toggle Game Log Footer
         */
        function toggleGameLogFooter() {
            const content = document.getElementById('gameLogFooterContent');
            const icon = document.getElementById('gameLogToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▲';
            } else {
                content.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        /**
         * Handle errors gracefully
         */
        window.addEventListener('error', (event) => {
            console.error('[God Mode] Error:', event.error);
            // Don't redirect on every error, just log it
        });

        /**
         * Sync data across tabs when switching
         */
        function syncTabData(tabName) {
            if (tabName === 'board') {
                // Clone the hex board from Matches tab to Board tab
                const mainBoard = document.getElementById('hexBoard');
                const altBoard = document.getElementById('hexBoardAlt');
                if (mainBoard && altBoard) {
                    // Copy HTML content
                    altBoard.innerHTML = mainBoard.innerHTML;

                    // Copy all inline styles (including transform rotation from board-renderer.js)
                    altBoard.style.cssText = mainBoard.style.cssText;
                }

                // Sync turn info
                const mainTurnInfo = document.getElementById('currentTurnInfo');
                const altTurnInfo = document.getElementById('currentTurnInfoBoard');
                if (mainTurnInfo && altTurnInfo) {
                    altTurnInfo.innerHTML = mainTurnInfo.innerHTML;
                }
            }

            if (tabName === 'stats') {
                // Sync statistics from small stats to big stats
                const syncStat = (smallId, bigId) => {
                    const small = document.getElementById(smallId);
                    const big = document.getElementById(bigId);
                    if (small && big) {
                        big.textContent = small.textContent;
                    }
                };

                syncStat('statGamesPlayed', 'statGamesPlayedBig');
                syncStat('statRound', 'statRoundBig');
                syncStat('statPlates', 'statPlatesBig');
                syncStat('statHearts', 'statHeartsBig');

                // Sync Team Rankings (since they were removed from Matches)
                // The teamsList is populated by updateTeamsList() function
                const teamsListStats = document.getElementById('teamsListStats');
                if (typeof updateTeamsList === 'function' && teamsListStats) {
                    // Call updateTeamsList which will populate teamsList
                    // Then copy that to Stats page
                    setTimeout(() => {
                        const teamsList = document.getElementById('teamsList');
                        if (teamsList && teamsListStats) {
                            teamsListStats.innerHTML = teamsList.innerHTML;
                        }
                    }, 100);
                }

                // Sync game log to match history
                const gameLog = document.getElementById('gameLog');
                const matchHistory = document.getElementById('matchHistoryLog');
                if (gameLog && matchHistory) {
                    matchHistory.innerHTML = gameLog.innerHTML;
                }
            }

            if (tabName === 'teams') {
                // Sync team data from Matches tab to Teams tab
                const playersList = document.getElementById('playersList');
                const teamsListPanel = document.getElementById('teamsListPanel');
                if (playersList && teamsListPanel) {
                    teamsListPanel.innerHTML = playersList.innerHTML;
                }
            }
        }

        /**
         * Tab Switching Function
         */
        function switchGodTab(tabName) {
            console.log('[God Mode] Switching to tab:', tabName);

            // Hide all tab panels
            document.querySelectorAll('.god-tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Remove active from all nav tabs
            document.querySelectorAll('.god-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected panel
            const targetPanel = document.getElementById(`${tabName}Panel`);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }

            // Mark nav tab as active
            const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Initialize board renderer if switching to Board tab
            if (tabName === 'board') {
                // Initialize board modules if not already done
                if (typeof initializeBoardModules === 'function' && !window.boardRenderer) {
                    setTimeout(() => {
                        console.log('[Board] Initializing board modules for Board tab');
                        initializeBoardModules();
                        // Render the board if we have game state
                        if (typeof renderBoard === 'function' && window.gameState) {
                            renderBoard();
                        }
                    }, 100);
                }
            }

            // Sync data for the target tab
            syncTabData(tabName);

            // If switching to Matches tab and gameId is already filled, auto-load
            if (tabName === 'matches') {
                const gameIdInput = document.getElementById('gameId');
                if (gameIdInput && gameIdInput.value.trim() && typeof loadGame === 'function') {
                    // Check if we haven't already loaded this tournament
                    const currentTournamentId = window.gameState?.tournamentId;
                    const inputTournamentId = gameIdInput.value.trim().split('/')[0]; // Extract tournament ID

                    if (currentTournamentId !== inputTournamentId) {
                        console.log('[God Mode] Auto-loading tournament from filled gameId field');
                        setTimeout(() => loadGame(), 500);
                    }
                }
            }

            // Save to sessionStorage
            sessionStorage.setItem('godActiveTab', tabName);

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.replaceState({}, '', url);
        }

        /**
         * Initialize from URL parameters and sessionStorage
         */
        function initializeFromURL() {
            const params = new URLSearchParams(window.location.search);
            const urlTournamentId = params.get('tournament') || params.get('game'); // Support both for backward compatibility
            const tabName = params.get('tab');

            // Check sessionStorage for persisted tournament
            const persistedTournamentId = sessionStorage.getItem('godSelectedTournament');

            // Priority: URL parameter > sessionStorage
            const tournamentId = urlTournamentId || persistedTournamentId;

            if (tournamentId) {
                console.log('[God Mode] Auto-loading tournament:', tournamentId);

                // Update tournament indicator in header
                updateTournamentIndicator(tournamentId);

                // Set gameId input on all relevant pages
                const gameIdInput = document.getElementById('gameId');
                if (gameIdInput) {
                    gameIdInput.value = tournamentId;
                }

                // Load tournament for user appointment system
                setTimeout(() => {
                    if (typeof loadTournamentForAppointment === 'function') {
                        loadTournamentForAppointment(tournamentId);
                    }
                }, 1000);

                // Auto-load game state for ALL tabs (not just Matches)
                if (typeof loadGame === 'function') {
                    setTimeout(() => {
                        console.log('[God Mode] Auto-loading game state for tournament:', tournamentId);
                        loadGame();
                    }, 1200);
                }

                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('tournament', tournamentId);
                if (tabName) {
                    url.searchParams.set('tab', tabName);
                }
                window.history.replaceState({}, '', url);
            }

            // Show last active tab or Tournaments tab by default
            const lastTab = sessionStorage.getItem('godActiveTab');
            setTimeout(() => {
                switchGodTab(tabName || lastTab || 'tournaments');
            }, 500);
        }

        // Initialize on Firebase ready
        document.addEventListener('firebase-ready', () => {
            initializeFromURL();
        });
    </script>
</body>
</html>