<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game View</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .game-board {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .team-info {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
    
    <!-- Load Firebase SDKs directly -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Game View</h1>
    
    <div id="connectionStatus" class="status warning">
        Connecting to Firebase...
    </div>
    
    <div id="gameInfo">
        <h2>Game Information</h2>
        <p>Loading game data...</p>
    </div>
    
    <div id="teamInfo">
        <h2>Teams</h2>
        <p>Loading team information...</p>
    </div>
    
    <div id="gameBoard" class="game-board">
        <h2>Game Board</h2>
        <p>Board visualization will appear here...</p>
    </div>
    
    <div id="gameControls">
        <h2>Game Controls</h2>
        <button id="backToSetup">Back to Setup</button>
    </div>
    
    <script>
        // Get game ID from URL
        function getGameIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('gameId');
        }
        
        // Initialize Firebase with configuration
        document.addEventListener('DOMContentLoaded', function() {
            // Load Firebase configuration from another script
            fetch('scripts/firebase.js')
                .then(response => response.text())
                .then(text => {
                    // Extract the Firebase configuration directly
                    const configMatch = text.match(/const\s+firebaseConfig\s*=\s*(\{[\s\S]*?\});/);
                    
                    if (!configMatch || !configMatch[1]) {
                        throw new Error('Could not find Firebase configuration in the file');
                    }
                    
                    // Manually extract the configuration values
                    const configText = configMatch[1];
                    const apiKeyMatch = configText.match(/apiKey:\s*["']([^"']+)["']/);
                    const authDomainMatch = configText.match(/authDomain:\s*["']([^"']+)["']/);
                    const projectIdMatch = configText.match(/projectId:\s*["']([^"']+)["']/);
                    const storageBucketMatch = configText.match(/storageBucket:\s*["']([^"']+)["']/);
                    const messagingSenderIdMatch = configText.match(/messagingSenderId:\s*["']([^"']+)["']/);
                    const appIdMatch = configText.match(/appId:\s*["']([^"']+)["']/);
                    const measurementIdMatch = configText.match(/measurementId:\s*["']([^"']+)["']/);
                    
                    // Create the configuration object manually
                    const firebaseConfig = {
                        apiKey: apiKeyMatch ? apiKeyMatch[1] : '',
                        authDomain: authDomainMatch ? authDomainMatch[1] : '',
                        projectId: projectIdMatch ? projectIdMatch[1] : '',
                        storageBucket: storageBucketMatch ? storageBucketMatch[1] : '',
                        messagingSenderId: messagingSenderIdMatch ? messagingSenderIdMatch[1] : '',
                        appId: appIdMatch ? appIdMatch[1] : '',
                        measurementId: measurementIdMatch ? measurementIdMatch[1] : ''
                    };
                    
                    // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);
                    const db = firebase.firestore();
                    
                    // Update connection status
                    const connectionStatus = document.getElementById('connectionStatus');
                    connectionStatus.textContent = 'Firebase connected successfully!';
                    connectionStatus.className = 'status success';
                    
                    // Get game ID from URL
                    const gameId = getGameIdFromUrl();
                    if (!gameId) {
                        document.getElementById('gameInfo').innerHTML = `
                            <h2>Game Information</h2>
                            <p class="error">No game ID specified. <a href="minimal-setup.html">Go back to setup</a>.</p>
                        `;
                        return;
                    }
                    
                    // Load game data
                    loadGameData(db, gameId);
                    
                    // Set up back button
                    document.getElementById('backToSetup').addEventListener('click', function() {
                        window.location.href = 'minimal-setup.html';
                    });
                })
                .catch(error => {
                    console.error('Error loading Firebase configuration:', error);
                    
                    const connectionStatus = document.getElementById('connectionStatus');
                    connectionStatus.textContent = 'Error connecting to Firebase: ' + error.message;
                    connectionStatus.className = 'status error';
                });
        });
        
        // Load game data from Firestore
        function loadGameData(db, gameId) {
            db.collection('games').doc(gameId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const gameData = doc.data();
                        displayGameInfo(gameData);
                        displayTeamInfo(gameData.teams);
                        displayGameBoard(gameData);
                    } else {
                        document.getElementById('gameInfo').innerHTML = `
                            <h2>Game Information</h2>
                            <p class="error">Game with ID "${gameId}" not found. <a href="minimal-setup.html">Go back to setup</a>.</p>
                        `;
                    }
                })
                .catch((error) => {
                    console.error('Error loading game data:', error);
                    document.getElementById('gameInfo').innerHTML = `
                        <h2>Game Information</h2>
                        <p class="error">Error loading game: ${error.message}</p>
                    `;
                });
        }
        
        // Display game information
        function displayGameInfo(gameData) {
            const gameInfo = document.getElementById('gameInfo');
            gameInfo.innerHTML = `
                <h2>Game: ${gameData.gameId}</h2>
                <p><strong>Status:</strong> ${gameData.gamePhase}</p>
                <p><strong>Created:</strong> ${new Date(gameData.createdAt).toLocaleString()}</p>
                <p><strong>Win Condition:</strong> ${gameData.winCondition} points</p>
                <p><strong>Games Played:</strong> ${gameData.gamesPlayed}</p>
                <p><strong>Current Round:</strong> ${gameData.currentRound}</p>
            `;
        }
        
        // Display team information
        function displayTeamInfo(teams) {
            const teamInfo = document.getElementById('teamInfo');
            teamInfo.innerHTML = '<h2>Teams</h2>';
            
            if (!teams || teams.length === 0) {
                teamInfo.innerHTML += '<p>No team information available</p>';
                return;
            }
            
            teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-info';
                teamDiv.innerHTML = `
                    <h3>${team.name} (${team.points} points)</h3>
                    <p><strong>Games Won:</strong> ${team.gamesWon}</p>
                    <p><strong>Players:</strong></p>
                    <ul>
                        ${team.players.map(player => `<li>${player.name}</li>`).join('')}
                    </ul>
                `;
                teamInfo.appendChild(teamDiv);
            });
        }
        
        // Display game board (simple version)
        function displayGameBoard(gameData) {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '<h2>Game Board</h2>';
            
            // Simple board representation for now
            gameBoard.innerHTML += `
                <p>This is a placeholder for the game board visualization.</p>
                <p>The board has ${Object.keys(gameData.board).length} occupied spaces.</p>
                <p>Heart hexes: ${gameData.heartHexes.join(', ')}</p>
            `;
            
            // If you want to add a more sophisticated board visualization later,
            // you can add it here
        }
    </script>
</body>
</html>