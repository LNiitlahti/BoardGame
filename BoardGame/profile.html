<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Settings - Board Game</title>

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
  <link rel="manifest" href="images/favicon/site.webmanifest">
  <link rel="shortcut icon" href="images/favicon/favicon.ico">

  <link rel="stylesheet" href="css/styles.css">
  <script src="scripts/firebase-loader.js"></script>
  <script type="module" src="scripts/errorHandler.js"></script>
  <script type="module" src="scripts/stateManager.js"></script>
  <style>
    .profile-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .profile-header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .profile-header-left h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: white;
    }

    .profile-header-left p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1rem;
    }

    .user-role-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 10px;
    }

    .user-role-badge.god {
      background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
      color: #1a1a1a;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .user-role-badge.admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .user-role-badge.player {
      background: linear-gradient(135deg, #00d4ff 0%, #00ffc8 100%);
      color: #1a1a1a;
    }

    .user-role-badge.user {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .profile-section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .profile-section h2 {
      color: #00d4ff;
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-label {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
    }

    .info-value {
      color: white;
      font-size: 1rem;
    }

    .info-value.editable {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s;
    }

    .info-value.editable:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #00d4ff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00d4ff;
      background: rgba(255, 255, 255, 0.1);
    }

    .tournament-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #00d4ff;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .tournament-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .tournament-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .tournament-header h4 {
      color: white;
      font-size: 1.1rem;
      margin: 0;
    }

    .tournament-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .tournament-status.setup {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid #fbbf24;
    }

    .tournament-status.playing {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid #10b981;
    }

    .tournament-status.finished {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
      border: 1px solid #94a3b8;
    }

    .tournament-info {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.5);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #00d4ff;
      margin-bottom: 5px;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <!-- Header -->
    <div class="profile-header">
      <div class="profile-header-left" style="display: flex; align-items: center; gap: 20px;">
        <img src="images/favicon/android-chrome-512x512.png" alt="Brand Logo" class="brand-logo">
        <div>
          <h1 style="margin: 0;">‚öôÔ∏è Profile Settings</h1>
          <p id="userEmail" style="margin: 10px 0 10px 0;">Loading...</p>
          <span id="userRoleBadge" class="user-role-badge">USER</span>
        </div>
      </div>
      <div>
        <button class="btn secondary" onclick="goToHome()">‚Üê Back to Home</button>
      </div>
    </div>

    <!-- Personal Information Section -->
    <div class="profile-section">
      <h2><span>üë§</span> Personal Information</h2>
      <div class="info-grid">
        <div class="info-label">Display Name:</div>
        <div class="info-value">
          <span id="displayNameValue">Loading...</span>
          <button class="btn-small" onclick="editDisplayName()" style="margin-left: 10px;">‚úèÔ∏è Edit</button>
        </div>

        <div class="info-label">Email:</div>
        <div class="info-value" id="emailValue">Loading...</div>

        <div class="info-label">User ID:</div>
        <div class="info-value" style="font-family: monospace; font-size: 0.85rem;" id="uidValue">Loading...</div>

        <div class="info-label">Role:</div>
        <div class="info-value" id="roleValue">Loading...</div>

        <div class="info-label">Member Since:</div>
        <div class="info-value" id="createdAtValue">Loading...</div>

        <div class="info-label">Last Login:</div>
        <div class="info-value" id="lastLoginValue">Loading...</div>
      </div>
    </div>

    <!-- Account Settings Section -->
    <div class="profile-section">
      <h2><span>üîê</span> Account Settings</h2>

      <div class="form-group">
        <label>Change Display Name</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="newDisplayName" placeholder="Enter new display name">
          <button class="btn primary" onclick="updateDisplayName()" style="white-space: nowrap;">Update Name</button>
        </div>
      </div>

      <div class="form-group">
        <label>Change Password</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" minlength="6">
          <button class="btn primary" onclick="updatePassword()" style="white-space: nowrap;">Update Password</button>
        </div>
        <small style="color: rgba(255, 255, 255, 0.6);">
          You'll be logged out after changing your password and need to log in again.
        </small>
      </div>
    </div>

    <!-- My Tournament Participation Section -->
    <div class="profile-section">
      <h2><span>üèÜ</span> My Tournament Participation</h2>

      <!-- My Stats -->
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-number" id="statMyTournaments">0</div>
          <div class="stat-label">My Tournaments</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="statMyGames">0</div>
          <div class="stat-label">Games Played</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="statMyWins">0</div>
          <div class="stat-label">Wins</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="statMyTeam">-</div>
          <div class="stat-label">Current Team</div>
        </div>
      </div>

      <!-- My Tournaments List -->
      <h3 style="color: rgba(255, 255, 255, 0.8); margin-top: 20px; margin-bottom: 15px;">
        Tournaments I'm Participating In
      </h3>
      <div id="myTournamentsList">
        <div class="empty-state">
          <p>Loading your tournaments...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { errorHandler } from './scripts/errorHandler.js';
    import { appState, connectionManager } from './scripts/stateManager.js';

    let auth, db;
    let currentUser = null;
    let userProfile = null;

    // Wait for Firebase
    document.addEventListener('firebase-ready', async function() {
      console.log('[Profile] Firebase ready');

      auth = firebase.auth();
      db = firebase.firestore();

      // Start connection monitoring
      connectionManager.start();

      // Check auth
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        currentUser = user;
        await loadUserProfile();
        await loadMyTournaments();
      });
    });

    async function loadUserProfile() {
      try {
        // Display basic info
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('emailValue').textContent = currentUser.email;
        document.getElementById('uidValue').textContent = currentUser.uid;

        // Load Firestore profile
        const userDoc = await db.collection('users').doc(currentUser.uid).get();

        if (userDoc.exists) {
          userProfile = userDoc.data();

          // Display name
          const displayName = userProfile.displayName || currentUser.displayName || 'Not set';
          document.getElementById('displayNameValue').textContent = displayName;
          document.getElementById('newDisplayName').value = displayName;

          // Role
          let role = 'user';
          if (userProfile.isGod === true) role = 'god';
          else if (userProfile.isAdmin === true) role = 'admin';
          else if (userProfile.isPlayer === true) role = 'player';

          const roleBadge = document.getElementById('userRoleBadge');
          roleBadge.textContent = role.toUpperCase();
          roleBadge.className = `user-role-badge ${role}`;

          document.getElementById('roleValue').innerHTML = `<span class="user-role-badge ${role}" style="padding: 4px 12px; font-size: 0.75rem;">${role.toUpperCase()}</span>`;

          // Dates
          if (userProfile.createdAt) {
            document.getElementById('createdAtValue').textContent = new Date(userProfile.createdAt).toLocaleDateString();
          }
          if (userProfile.lastLogin) {
            document.getElementById('lastLoginValue').textContent = new Date(userProfile.lastLogin).toLocaleString();
          }

          // Store in app state
          appState.set('currentUser', currentUser);
          appState.set('userProfile', userProfile);
        }
      } catch (error) {
        console.error('[Profile] Error loading profile:', error);
        errorHandler.handleFirebaseError(error, 'loadUserProfile');
      }
    }

    async function loadMyTournaments() {
      try {
        // Load tournaments where user is a participant
        const tournamentsSnapshot = await db.collection('tournaments').get();
        const myTournaments = [];
        let totalGames = 0;
        let totalWins = 0;
        let currentTeamName = null;

        tournamentsSnapshot.forEach(doc => {
          const tournament = { id: doc.id, ...doc.data() };

          // Check if user is in any team in this tournament
          if (tournament.teams && Array.isArray(tournament.teams)) {
            const myTeam = tournament.teams.find(team =>
              team.players && team.players.some(player => player.uid === currentUser.uid)
            );

            if (myTeam) {
              myTournaments.push({
                ...tournament,
                myTeam: myTeam
              });

              // Calculate stats
              if (myTeam.gamesPlayed) totalGames += myTeam.gamesPlayed;
              if (myTeam.gamesWon) totalWins += myTeam.gamesWon;
              if (!currentTeamName && tournament.status === 'playing') {
                currentTeamName = myTeam.name;
              }
            }
          }
        });

        // Update stats
        document.getElementById('statMyTournaments').textContent = myTournaments.length;
        document.getElementById('statMyGames').textContent = totalGames;
        document.getElementById('statMyWins').textContent = totalWins;
        document.getElementById('statMyTeam').textContent = currentTeamName || '-';

        // Display tournaments
        displayMyTournaments(myTournaments);

      } catch (error) {
        console.error('[Profile] Error loading tournaments:', error);
        errorHandler.handleFirebaseError(error, 'loadMyTournaments');
      }
    }

    function displayMyTournaments(tournaments) {
      const container = document.getElementById('myTournamentsList');

      if (tournaments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>You're not participating in any tournaments yet.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tournaments.map(tournament => {
        const status = tournament.status || 'setup';
        const createdDate = tournament.createdAt ? new Date(tournament.createdAt).toLocaleDateString() : 'Unknown';

        return `
          <div class="tournament-card">
            <div class="tournament-header">
              <h4>üèÜ ${tournament.name || tournament.id}</h4>
              <span class="tournament-status ${status}">${status}</span>
            </div>
            <div class="tournament-info">
              <div><strong>My Team:</strong> ${tournament.myTeam.name}</div>
              <div><strong>Created:</strong> ${createdDate}</div>
              ${tournament.myTeam.points !== undefined ? `<div><strong>Team Points:</strong> ${tournament.myTeam.points}</div>` : ''}
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn secondary" onclick="viewTournament('${tournament.gameId || tournament.id}')">üëÅÔ∏è View</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Global functions
    window.goToHome = function() {
      window.location.href = 'home.html';
    };

    window.editDisplayName = function() {
      document.getElementById('newDisplayName').focus();
    };

    window.updateDisplayName = async function() {
      const newName = document.getElementById('newDisplayName').value.trim();

      if (!newName) {
        errorHandler.showError('Please enter a display name');
        return;
      }

      try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
          displayName: newName,
          updatedAt: new Date().toISOString()
        });

        // Update display
        document.getElementById('displayNameValue').textContent = newName;

        errorHandler.showSuccess('Display name updated successfully!');

        // Reload profile
        await loadUserProfile();
      } catch (error) {
        console.error('[Profile] Error updating display name:', error);
        errorHandler.handleFirebaseError(error, 'updateDisplayName');
      }
    };

    window.updatePassword = async function() {
      const newPassword = document.getElementById('newPassword').value;

      if (!newPassword || newPassword.length < 6) {
        errorHandler.showError('Password must be at least 6 characters long');
        return;
      }

      if (!confirm('Are you sure you want to change your password? You will be logged out and need to log in again.')) {
        return;
      }

      try {
        await currentUser.updatePassword(newPassword);

        errorHandler.showSuccess('Password updated successfully! Logging out...');

        // Log out after password change
        setTimeout(async () => {
          await auth.signOut();
          window.location.href = 'index.html';
        }, 2000);
      } catch (error) {
        console.error('[Profile] Error updating password:', error);

        if (error.code === 'auth/requires-recent-login') {
          errorHandler.showError('For security, please log out and log in again before changing your password.');
        } else {
          errorHandler.handleFirebaseError(error, 'updatePassword');
        }
      }
    };

    window.viewTournament = function(tournamentId) {
      window.location.href = `view.html?gameId=${tournamentId}`;
    };
  </script>
</body>
</html>
