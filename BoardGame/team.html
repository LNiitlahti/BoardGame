<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Team View</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h2 {
            margin-top: 0;
            color: #444;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .team-selector {
            margin: 20px 0;
        }
        .team-selector select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .player-list {
            list-style: none;
            padding: 0;
        }
        .player-list li {
            padding: 8px;
            margin: 5px 0;
            background-color: #f9f9f9;
            border-left: 3px solid #4CAF50;
            border-radius: 3px;
        }
        .stat {
            display: inline-block;
            margin-right: 20px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .nav-links {
            margin: 20px 0;
        }
        .nav-links a {
            display: inline-block;
            padding: 10px 15px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .nav-links a:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Team Dashboard</h1>
    
    <div id="connectionStatus" class="status warning">
        Connecting to Firebase...
    </div>
    
    <div class="nav-links" id="navLinks" style="display: none;">
        <a href="#" id="setupLink">Setup</a>
        <a href="#" id="gameLink">Game Board</a>
        <a href="#" id="adminLink">Admin</a>
    </div>
    
    <div class="team-selector" id="teamSelector" style="display: none;">
        <label for="teamSelect"><strong>Select Your Team:</strong></label>
        <select id="teamSelect">
            <option value="">-- Choose Team --</option>
        </select>
    </div>
    
    <div id="content" style="display: none;">
        <div class="panel" id="teamInfo">
            <h2>Team Information</h2>
            <div class="loading">Select a team above</div>
        </div>
        
        <div class="panel" id="gameStatus">
            <h2>Game Status</h2>
            <div class="loading">Loading game status...</div>
        </div>
        
        <div class="panel" id="teamHistory">
            <h2>Team History</h2>
            <div class="loading">Loading team history...</div>
        </div>
    </div>
    
    <!-- Load Firebase scripts directly -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        let db = null;
        let gameId = null;
        let currentTeamId = null;
        
        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            gameId = urlParams.get('gameId');
            const teamId = urlParams.get('teamId');
            
            if (!gameId) {
                document.getElementById('connectionStatus').textContent = 'No game ID provided in URL';
                document.getElementById('connectionStatus').className = 'status error';
                return false;
            }
            
            return { gameId, teamId };
        }
        
        // Update navigation links
        function updateNavLinks() {
            const setupLink = document.getElementById('setupLink');
            const gameLink = document.getElementById('gameLink');
            const adminLink = document.getElementById('adminLink');
            
            setupLink.href = `minimal-setup.html`;
            gameLink.href = `game.html?gameId=${gameId}${currentTeamId ? `&teamId=${currentTeamId}` : ''}`;
            adminLink.href = `admin.html?gameId=${gameId}`;
            
            document.getElementById('navLinks').style.display = 'block';
        }
        
        // Load game data and populate team selector
        function loadGameData() {
            db.collection('games').doc(gameId).get()
                .then((doc) => {
                    if (!doc.exists) {
                        throw new Error('Game not found');
                    }
                    
                    const gameData = doc.data();
                    
                    // Populate team selector
                    const teamSelect = document.getElementById('teamSelect');
                    teamSelect.innerHTML = '<option value="">-- Choose Team --</option>';
                    
                    if (gameData.teams) {
                        gameData.teams.forEach(team => {
                            const option = document.createElement('option');
                            option.value = team.id;
                            option.textContent = `${team.name} (${team.points} points)`;
                            teamSelect.appendChild(option);
                        });
                    }
                    
                    document.getElementById('teamSelector').style.display = 'block';
                    document.getElementById('content').style.display = 'block';
                    
                    // If teamId in URL, auto-select it
                    const params = getUrlParams();
                    if (params.teamId) {
                        teamSelect.value = params.teamId;
                        loadTeamData(params.teamId, gameData);
                    }
                    
                    // Load game status
                    loadGameStatus(gameData);
                })
                .catch((error) => {
                    console.error('Error loading game:', error);
                    document.getElementById('connectionStatus').textContent = 'Error loading game: ' + error.message;
                    document.getElementById('connectionStatus').className = 'status error';
                });
        }
        
        // Load specific team data
        function loadTeamData(teamId, gameData) {
            currentTeamId = teamId;
            updateNavLinks();
            
            const team = gameData.teams.find(t => t.id == teamId);
            
            if (!team) {
                document.getElementById('teamInfo').innerHTML = '<h2>Team Information</h2><p>Team not found</p>';
                return;
            }
            
            // Display team info
            let teamHtml = `
                <h2>${team.name}</h2>
                <div class="stat">Team Points: ${team.points}</div>
                <div class="stat">Games Won: ${team.gamesWon || 0}</div>
                <h3>Players:</h3>
                <ul class="player-list">
            `;
            
            team.players.forEach(player => {
                teamHtml += `<li>${player.name} - ${player.points} points</li>`;
            });
            
            teamHtml += '</ul>';
            document.getElementById('teamInfo').innerHTML = teamHtml;
            
            // Load team history
            loadTeamHistory(teamId, gameData);
        }
        
        // Load game status
        function loadGameStatus(gameData) {
            let statusHtml = '<h2>Game Status</h2>';
            statusHtml += `<p><strong>Game ID:</strong> ${gameData.gameId}</p>`;
            statusHtml += `<p><strong>Current Round:</strong> ${gameData.currentRound}</p>`;
            statusHtml += `<p><strong>Games Played:</strong> ${gameData.gamesPlayed}</p>`;
            statusHtml += `<p><strong>Win Condition:</strong> ${gameData.winCondition} points</p>`;
            statusHtml += `<p><strong>Game Phase:</strong> ${gameData.gamePhase}</p>`;
            
            if (gameData.currentTurn) {
                statusHtml += `<p><strong>Current Turn:</strong> Team ${gameData.currentTurn}</p>`;
            }
            
            document.getElementById('gameStatus').innerHTML = statusHtml;
        }
        
        // Load team history
        function loadTeamHistory(teamId, gameData) {
            let historyHtml = '<h2>Team History</h2>';
            
            if (!gameData.gameHistory || gameData.gameHistory.length === 0) {
                historyHtml += '<p>No games played yet</p>';
            } else {
                // Filter history for this team
                const teamHistory = gameData.gameHistory.filter(game => 
                    game.winner == teamId || 
                    (game.teams && game.teams.includes(parseInt(teamId)))
                );
                
                if (teamHistory.length === 0) {
                    historyHtml += '<p>No games played by this team yet</p>';
                } else {
                    historyHtml += '<ul class="player-list">';
                    teamHistory.forEach(game => {
                        const isWinner = game.winner == teamId;
                        historyHtml += `
                            <li>
                                <strong>${game.gameType || 'Unknown'}</strong> - 
                                ${game.playType || 'Unknown'} - 
                                ${isWinner ? '🏆 WON' : '❌ LOST'}
                                ${game.hex ? ` (Hex: ${game.hex})` : ''}
                            </li>
                        `;
                    });
                    historyHtml += '</ul>';
                }
            }
            
            document.getElementById('teamHistory').innerHTML = historyHtml;
        }
        
        // Initialize Firebase and load data
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL params first
            if (!getUrlParams()) {
                return;
            }
            
            const firebaseConfig = {
                apiKey: "AIzaSyCJsd9NmSaV9QYcIC2pVH7PkRB9iKiYxf8",
                authDomain: "boardgame-7b9f0.firebaseapp.com",
                projectId: "boardgame-7b9f0",
                storageBucket: "boardgame-7b9f0.firebasestorage.app",
                messagingSenderId: "1001331148981",
                appId: "1:1001331148981:web:5094c89e3b6cf056c696fc",
                measurementId: "G-22Y0E9VTPV"
            };
            
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Update connection status
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.textContent = 'Firebase connected successfully!';
                connectionStatus.className = 'status success';
                
                // Update nav links
                updateNavLinks();
                
                // Load game data
                loadGameData();
                
                // Set up team selector listener
                document.getElementById('teamSelect').addEventListener('change', function(e) {
                    const selectedTeamId = e.target.value;
                    if (selectedTeamId) {
                        // Reload game data to get fresh data
                        db.collection('games').doc(gameId).get()
                            .then((doc) => {
                                if (doc.exists) {
                                    loadTeamData(selectedTeamId, doc.data());
                                }
                            });
                    }
                });
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.textContent = 'Error initializing Firebase: ' + error.message;
                connectionStatus.className = 'status error';
            }
        });
    </script>
</body>
</html>