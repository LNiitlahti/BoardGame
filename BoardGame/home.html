<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Board Game - Home</title>

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
  <link rel="manifest" href="images/favicon/site.webmanifest">
  <link rel="shortcut icon" href="images/favicon/favicon.ico">

  <link rel="stylesheet" href="css/styles.css">
  <script src="scripts/firebase-loader.js"></script>
  <script type="module" src="scripts/errorHandler.js"></script>
  <script type="module" src="scripts/stateManager.js"></script>
  <script type="module" src="scripts/utils.js"></script>
  <style>
    .home-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .header-left h1 {
      font-size: 2rem;
      margin-bottom: 5px;
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-left p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
    }

    .header-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-badge {
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-badge.god {
      background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
      color: #1a1a1a;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .user-badge.admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .user-badge.player {
      background: linear-gradient(135deg, #00d4ff 0%, #00ffc8 100%);
      color: #1a1a1a;
    }

    .user-badge.user {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .dashboard-card h3 {
      color: #ffd700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-icon {
      font-size: 1.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #00d4ff;
      margin: 10px 0;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-small {
      padding: 8px 15px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00d4ff 0%, #00ffc8 100%);
      color: #1a1a1a;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-god {
      background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
      color: #1a1a1a;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .board-preview {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }

    .board-preview h3 {
      color: #ffd700;
      margin-bottom: 15px;
    }

    #boardContainer {
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.5);
    }

    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .role-section {
      display: none;
    }

    .role-section.active {
      display: block;
    }

    /* Connection status indicator */
    #connectionStatus {
      position: fixed;
      top: 20px;
      right: 20px;
    }

    /* Tournament cards */
    .tournament-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .tournament-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .tournament-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .tournament-header h4 {
      color: #ffd700;
      font-size: 1.1rem;
      margin: 0;
    }

    .tournament-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .tournament-status.setup {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid #fbbf24;
    }

    .tournament-status.playing {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid #10b981;
    }

    .tournament-status.finished,
    .tournament-status.complete {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
      border: 1px solid #94a3b8;
    }

    .tournament-info {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 15px;
      line-height: 1.8;
    }

    .tournament-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.5);
    }

    /* Custom Modal for Referral Codes */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }

    .custom-modal-overlay.active {
      display: flex;
    }

    .custom-modal {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      border-radius: 15px;
      padding: 30px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 215, 0, 0.3);
      animation: slideIn 0.3s ease;
    }

    .custom-modal h2 {
      color: #ffd700;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.5rem;
    }

    .codes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .code-section h3 {
      color: #00d4ff;
      font-size: 1.1rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(0, 212, 255, 0.3);
    }

    .code-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }

    .code-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #ffd700;
    }

    .code-item.clickable-code:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .code-item.clickable-code:active {
      transform: scale(0.98);
    }

    .code-item.copied {
      animation: copyPulse 0.5s ease;
      background: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
    }

    @keyframes copyPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .code-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .code-value {
      font-family: 'Courier New', monospace;
      font-size: 1.1rem;
      font-weight: bold;
      color: #ffd700;
      letter-spacing: 2px;
    }

    .code-status {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .code-status.available {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid #10b981;
    }

    .code-status.used {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid #ef4444;
    }

    .code-details {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.6;
    }

    .modal-footer {
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer-stats {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 15px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>
</head>
<body>
  <!-- Connection Status -->
  <div id="connectionStatus" class="connection-dot"></div>

  <!-- Referral Codes Modal -->
  <div id="referralCodesModal" class="custom-modal-overlay" onclick="closeReferralCodesModal(event)">
    <div class="custom-modal" onclick="event.stopPropagation()">
      <h2>üé´ Referral Codes</h2>
      <div id="referralCodesContent"></div>
      <div class="modal-footer">
        <div class="modal-footer-stats" id="modalFooterStats"></div>
        <button class="btn-small btn-primary" onclick="closeReferralCodesModal()">Close</button>
      </div>
    </div>
  </div>

  <div class="home-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left" style="display: flex; align-items: center; gap: 20px;">
        <img src="images/favicon/android-chrome-512x512.png" alt="Brand Logo" class="brand-logo">
        <div>
          <h1 style="margin: 0;">üéÆ Welcome Back, <span id="userName">User</span>!</h1>
          <p id="roleDescription" style="margin: 5px 0 0 0;">Loading your dashboard...</p>
        </div>
      </div>
      <div class="header-right">
        <span id="userBadge" class="user-badge">USER</span>
        <button class="btn-small btn-secondary" onclick="goToPage('profile.html')">‚öôÔ∏è Settings</button>
        <button class="btn-small btn-secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- GOD MODE Section (Superadmin) -->
    <div id="godSection" class="role-section">
      <h2 style="color: #ffd700; margin-bottom: 20px;">‚ö° GOD MODE - Complete Control</h2>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3><span class="card-icon">üéÆ</span> Game Management</h3>
          <div class="action-buttons" style="flex-wrap: wrap;">
            <button class="btn-small btn-god" onclick="goToPage('god.html')">üëë God Panel</button>
            <button class="btn-small btn-secondary" onclick="goToPage('setup.html')">üéÆ New Game</button>
            <button class="btn-small btn-primary" onclick="manageTeams()">üë• Manage Teams</button>
            <button class="btn-small btn-primary" onclick="manageSpells()">‚ú® Manage Spells</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üë•</span> User Management</h3>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="manageUsers()">Manage Users</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üèÜ</span> Tournament Overview</h3>
          <div class="stat-value" id="activeTournaments">0</div>
          <div class="stat-label">Active Tournaments</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="manageTournaments()">View All</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">‚öôÔ∏è</span> System Status</h3>
          <div class="stat-label">All systems operational</div>
          <div class="action-buttons">
            <button class="btn-small btn-secondary" onclick="viewLogs()">View Logs</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üé´</span> Referral Codes</h3>
          <div class="stat-value" id="totalReferralCodes">0</div>
          <div class="stat-label"><span id="usedReferralCodes">0</span> used, <span id="unusedReferralCodes">0</span> available</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="generateReferralCode()">Generate Code</button>
            <button class="btn-small btn-secondary" onclick="viewReferralCodes()">View All</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN Section -->
    <div id="adminSection" class="role-section">
      <h2 style="color: #667eea; margin-bottom: 20px;">üõ°Ô∏è Admin Dashboard</h2>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3><span class="card-icon">üéÆ</span> Current Game</h3>
          <div class="stat-value" id="adminCurrentRound">1</div>
          <div class="stat-label">Current Round</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="goToPage('god.html')">Manage Game</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üìã</span> Pending Matches</h3>
          <div class="stat-value" id="adminPendingMatches">0</div>
          <div class="stat-label">Awaiting Results</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="confirmResults()">Confirm Results</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üë•</span> Teams</h3>
          <div class="stat-value" id="adminTotalTeams">0</div>
          <div class="stat-label">Active Teams</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="manageTeams()">Manage Teams</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PLAYER Section -->
    <div id="playerSection" class="role-section">
      <h2 style="color: #00d4ff; margin-bottom: 20px;">üéØ Player Dashboard</h2>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3><span class="card-icon">üë•</span> My Team</h3>
          <div class="stat-value" id="playerTeamName">Loading...</div>
          <div class="stat-label" id="playerTeamPoints">0 points</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="viewTeamDetails()">Team Details</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üèÜ</span> My Stats</h3>
          <div class="stat-value" id="playerWins">0</div>
          <div class="stat-label">Games Won</div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üé¥</span> Spell Cards</h3>
          <div class="stat-value" id="playerSpellCards">0</div>
          <div class="stat-label">Available Cards</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="viewSpellCards()">View Cards</button>
          </div>
        </div>

        <div class="dashboard-card">
          <h3><span class="card-icon">üìÖ</span> Next Match</h3>
          <div class="stat-label" id="playerNextMatch">No matches scheduled</div>
          <div class="action-buttons">
            <button class="btn-small btn-primary" onclick="viewSchedule()">View Schedule</button>
          </div>
        </div>
      </div>
    </div>

    <!-- REGULAR USER Section -->
    <div id="userSection" class="role-section">
      <h2 style="color: #ffffff; margin-bottom: 20px;">üë§ User Dashboard</h2>

      <div class="dashboard-card">
        <h3><span class="card-icon">‚ÑπÔ∏è</span> Welcome</h3>
        <p style="color: rgba(255, 255, 255, 0.8);">
          You're logged in but don't have an assigned role yet.
          Contact an administrator to be assigned to a team.
        </p>
        <div class="action-buttons">
          <button class="btn-small btn-primary" onclick="goToPage('profile.html')">View Profile</button>
          <button class="btn-small btn-secondary" onclick="contactAdmin()">Contact Admin</button>
        </div>
      </div>
    </div>

    <!-- Recent Tournaments (shown for all roles) -->
    <div class="board-preview" style="margin-bottom: 30px;">
      <h3>üèÜ Recent Tournaments</h3>
      <div id="recentTournaments" class="dashboard-grid" style="margin-top: 20px;">
        <!-- Tournaments will be loaded here -->
      </div>
    </div>
  </div>

  <script type="module">
    import { errorHandler } from './scripts/errorHandler.js';
    import { appState, connectionManager } from './scripts/stateManager.js';

    let auth, db;
    let currentUser = null;
    let userRole = null;

    // Wait for Firebase
    document.addEventListener('firebase-ready', async function() {
      console.log('[Home] Firebase ready');

      auth = firebase.auth();
      db = firebase.firestore();

      // Start connection monitoring
      connectionManager.start();

      // Check auth
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          // Not logged in ‚Üí redirect to index (router)
          window.location.href = 'index.html';
          return;
        }

        currentUser = user;

        // Get role from URL or sessionStorage
        const urlParams = new URLSearchParams(window.location.search);
        userRole = urlParams.get('role') || sessionStorage.getItem('userRole') || 'user';

        console.log('[Home] User role:', userRole);

        // Load profile
        await loadUserProfile(user.uid);

        // Show appropriate section
        showRoleSection(userRole);

        // Load role-specific data
        await loadRoleData(userRole);

        // Load tournaments (for all roles)
        await loadRecentTournaments();
      });
    });

    async function loadUserProfile(uid) {
      try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          document.getElementById('userName').textContent = userData.displayName || 'User';

          // Store in app state
          appState.set('currentUser', currentUser);
          appState.set('userProfile', userData);
        }
      } catch (error) {
        console.error('[Home] Error loading profile:', error);
        errorHandler.handleFirebaseError(error, 'loadUserProfile');
      }
    }

    function showRoleSection(role) {
      // Hide all sections
      document.querySelectorAll('.role-section').forEach(section => {
        section.classList.remove('active');
      });

      // Update badge
      const badge = document.getElementById('userBadge');
      badge.className = `user-badge ${role}`;
      badge.textContent = role.toUpperCase();

      // Update description
      const descriptions = {
        'god': 'You have complete control over the system',
        'admin': 'Manage games, matches, and players',
        'player': 'View your team stats and upcoming matches',
        'user': 'Contact admin for role assignment'
      };
      document.getElementById('roleDescription').textContent = descriptions[role] || '';

      // Show appropriate section
      const sectionMap = {
        'god': 'godSection',
        'admin': 'adminSection',
        'player': 'playerSection',
        'user': 'userSection'
      };
      const sectionId = sectionMap[role] || 'userSection';
      document.getElementById(sectionId).classList.add('active');
    }

    async function loadRoleData(role) {
      try {
        switch (role) {
          case 'god':
            await loadGodData();
            break;
          case 'admin':
            await loadAdminData();
            break;
          case 'player':
            await loadPlayerData();
            break;
        }
      } catch (error) {
        console.error('[Home] Error loading role data:', error);
        errorHandler.handleFirebaseError(error, 'loadRoleData');
      }
    }

    async function loadGodData() {
      // Load system statistics
      const usersSnapshot = await db.collection('users').get();
      document.getElementById('totalUsers').textContent = usersSnapshot.size;

      const tournamentsSnapshot = await db.collection('tournaments').where('status', '==', 'playing').get();
      document.getElementById('activeTournaments').textContent = tournamentsSnapshot.size;

      // Load referral code statistics
      const referralCodesSnapshot = await db.collection('referralCodes').get();
      const totalCodes = referralCodesSnapshot.size;
      const usedCodes = referralCodesSnapshot.docs.filter(doc => doc.data().used === true).length;
      const unusedCodes = totalCodes - usedCodes;

      document.getElementById('totalReferralCodes').textContent = totalCodes;
      document.getElementById('usedReferralCodes').textContent = usedCodes;
      document.getElementById('unusedReferralCodes').textContent = unusedCodes;
    }

    async function loadAdminData() {
      // Load admin-specific data
      const tournamentsSnapshot = await db.collection('tournaments').limit(1).get();
      if (!tournamentsSnapshot.empty) {
        const tournamentData = tournamentsSnapshot.docs[0].data();
        document.getElementById('adminCurrentRound').textContent = tournamentData.currentRound || 1;
        document.getElementById('adminPendingMatches').textContent = tournamentData.gameQueue?.filter(m => m.status === 'pending').length || 0;
        document.getElementById('adminTotalTeams').textContent = tournamentData.teams?.length || 0;
      }
    }

    async function loadPlayerData() {
      const userProfile = appState.get('userProfile');
      if (userProfile && userProfile.teamId) {
        // Load team data
        const teamDoc = await db.collection('teams').doc(userProfile.teamId).get();
        if (teamDoc.exists) {
          const teamData = teamDoc.data();
          document.getElementById('playerTeamName').textContent = teamData.name || 'Unknown';
          document.getElementById('playerTeamPoints').textContent = `${teamData.points || 0} points`;
          document.getElementById('playerSpellCards').textContent = teamData.spellCards?.length || 0;
          document.getElementById('playerWins').textContent = teamData.gamesWon || 0;
        }
      }
    }

    async function loadRecentTournaments() {
      try {
        const tournamentsSnapshot = await db.collection('tournaments').get();
        const tournaments = [];

        tournamentsSnapshot.forEach(doc => {
          tournaments.push({ id: doc.id, ...doc.data() });
        });

        // Sort by creation date (newest first)
        tournaments.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
        });

        // Limit to 6 most recent
        const recentTournaments = tournaments.slice(0, 6);

        displayTournaments(recentTournaments);

      } catch (error) {
        console.error('[Home] Error loading tournaments:', error);
        errorHandler.handleFirebaseError(error, 'loadRecentTournaments');
      }
    }

    function displayTournaments(tournaments) {
      const container = document.getElementById('recentTournaments');

      if (tournaments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No tournaments found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = tournaments.map(tournament => {
        const status = tournament.status || 'setup';
        const createdDate = tournament.createdAt ? new Date(tournament.createdAt).toLocaleDateString() : 'Unknown';
        const tournamentId = tournament.gameId || tournament.id;

        // Find user's team in this tournament
        let userTeamId = null;
        let userTeamName = null;
        const userProfile = appState.get('userProfile');

        if (tournament.teams && Array.isArray(tournament.teams) && currentUser) {
          const userTeam = tournament.teams.find(team =>
            team.players && team.players.some(player => player.uid === currentUser.uid)
          );
          if (userTeam) {
            userTeamId = userTeam.id;
            userTeamName = userTeam.name;
          }
        }

        // Determine if user is GOD (can delete)
        const isGod = userRole === 'god' || userProfile?.isGod === true;
        const isAdmin = userRole === 'admin' || userRole === 'god' || userProfile?.isAdmin === true;

        return `
          <div class="tournament-card">
            <div class="tournament-header">
              <h4>üèÜ ${tournament.name || tournamentId}</h4>
              <span class="tournament-status ${status}">${status}</span>
            </div>
            <div class="tournament-info">
              <div><strong>ID:</strong> ${tournamentId}</div>
              <div><strong>Created:</strong> ${createdDate}</div>
              ${tournament.teams ? `<div><strong>Teams:</strong> ${tournament.teams.length}</div>` : ''}
              ${tournament.gamesPlayed !== undefined ? `<div><strong>Games Played:</strong> ${tournament.gamesPlayed}</div>` : ''}
              ${userTeamName ? `<div><strong>Your Team:</strong> ${userTeamName}</div>` : ''}
            </div>
            <div class="tournament-actions">
              <button class="btn-small btn-secondary" onclick="viewTournament('${tournamentId}')">View</button>
              ${isAdmin ? `<button class="btn-small btn-primary" onclick="manageTournament('${tournamentId}')">Manage</button>` : ''}
              ${userTeamId ? `<button class="btn-small btn-success" onclick="goToTeamControls('${tournamentId}', ${userTeamId})">Team Controls</button>` : ''}
              ${isGod ? `<button class="btn-small btn-danger" onclick="deleteTournamentConfirm('${tournamentId}', '${tournament.name || tournamentId}')">Delete</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function deleteTournamentConfirm(tournamentId, tournamentName) {
      const confirmMessage = `‚ö†Ô∏è WARNING: You are about to PERMANENTLY DELETE this tournament!\n\nTournament: ${tournamentName}\nID: ${tournamentId}\n\nThis will delete:\n- All match data\n- Game history\n- Board states\n- Team assignments\n\nThis action CANNOT be undone!\n\nType the tournament name to confirm deletion:`;

      const userInput = prompt(confirmMessage);

      if (userInput === null) {
        return; // User cancelled
      }

      if (userInput !== tournamentName && userInput !== tournamentId) {
        errorHandler.showError('Tournament name does not match. Deletion cancelled.');
        return;
      }

      // Final confirmation
      if (!confirm(`FINAL CONFIRMATION:\n\nAre you absolutely sure you want to delete "${tournamentName}"?\n\nClick OK to DELETE PERMANENTLY.`)) {
        return;
      }

      try {
        await db.collection('tournaments').doc(tournamentId).delete();
        errorHandler.showSuccess(`Tournament "${tournamentName}" has been permanently deleted.`);

        // Reload tournaments
        await loadRecentTournaments();

      } catch (error) {
        console.error('[Home] Error deleting tournament:', error);
        errorHandler.handleFirebaseError(error, 'deleteTournament');
      }
    }

    // Global functions for buttons
    window.viewTournament = function(tournamentId) {
      window.location.href = `view.html?gameId=${tournamentId}`;
    };

    window.manageTournament = function(tournamentId) {
      window.location.href = `god.html?tournament=${tournamentId}`;
    };

    window.goToTeamControls = function(tournamentId, teamId) {
      // Navigate to team controls page
      window.location.href = `team.html?gameId=${tournamentId}&teamId=${teamId}`;
    };

    window.deleteTournamentConfirm = deleteTournamentConfirm;

    window.logout = async function() {
      try {
        await auth.signOut();
        errorHandler.showSuccess('Logged out successfully');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 500);
      } catch (error) {
        errorHandler.handleFirebaseError(error, 'logout');
      }
    };

    window.goToPage = function(page) {
      window.location.href = page;
    };

    window.createNewGame = function() {
      errorHandler.showInfo('Redirecting to game setup...');
      setTimeout(() => window.location.href = 'setup.html', 500);
    };

    window.manageUsers = function() {
      window.location.href = 'god.html?tab=users';
    };

    window.manageTournaments = function() {
      errorHandler.showInfo('Tournament management coming soon');
    };

    window.viewLogs = function() {
      errorHandler.showInfo('System logs coming soon');
    };

    window.manageTeams = async function() {
      try {
        // Fetch all tournaments
        const tournamentsSnapshot = await db.collection('tournaments').get();

        if (tournamentsSnapshot.empty) {
          errorHandler.showError('No tournaments found. Create a tournament first.');
          return;
        }

        // Build list of tournaments
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
          const data = doc.data();
          tournaments.push({
            id: doc.id,
            name: data.name || doc.id,
            status: data.status || 'setup',
            teamsCount: data.teams ? data.teams.length : 0
          });
        });

        // Sort by status (playing first, then setup, then finished)
        tournaments.sort((a, b) => {
          const statusOrder = { playing: 1, setup: 2, finished: 3, complete: 3 };
          return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
        });

        // Create options for prompt
        let message = 'üìã SELECT A TOURNAMENT TO MANAGE TEAMS:\n\n';
        tournaments.forEach((t, index) => {
          message += `${index + 1}. ${t.name} [${t.status.toUpperCase()}] - ${t.teamsCount} teams\n`;
        });
        message += '\nEnter the number of the tournament:';

        const userInput = prompt(message);

        if (userInput === null) {
          return; // User cancelled
        }

        const selectedIndex = parseInt(userInput) - 1;

        if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= tournaments.length) {
          errorHandler.showError('Invalid selection. Please try again.');
          return;
        }

        const selectedTournament = tournaments[selectedIndex];

        // Redirect to god.html with tournament selected
        window.location.href = `god.html?tournament=${selectedTournament.id}`;

      } catch (error) {
        console.error('[Home] Error loading tournaments:', error);
        errorHandler.handleFirebaseError(error, 'manageTeams');
      }
    };

    window.manageSpells = function() {
      errorHandler.showInfo('Spell management coming soon');
    };

    window.confirmResults = function() {
      errorHandler.showInfo('Redirecting to result confirmation...');
      setTimeout(() => window.location.href = 'god.html#confirm', 500);
    };

    window.viewTeamDetails = function() {
      errorHandler.showInfo('Team details feature coming soon');
    };

    window.viewSpellCards = function() {
      errorHandler.showInfo('Spell cards feature coming soon');
    };

    window.viewSchedule = function() {
      errorHandler.showInfo('Match schedule coming soon');
    };

    window.contactAdmin = function() {
      errorHandler.showInfo('Please contact your tournament administrator');
    };

    // Referral code management (God mode only)
    window.generateReferralCode = async function() {
      try {
        // Generate a random 8-character alphanumeric code
        const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Excluding similar chars (0,O,1,I)
        let code = '';
        for (let i = 0; i < 8; i++) {
          code += characters.charAt(Math.floor(Math.random() * characters.length));
        }

        // Check if code already exists
        const existingCode = await db.collection('referralCodes').doc(code).get();
        if (existingCode.exists) {
          errorHandler.showWarning('Code collision detected. Please try again.');
          return;
        }

        // Create the referral code document
        await db.collection('referralCodes').doc(code).set({
          code: code,
          used: false,
          createdAt: new Date().toISOString(),
          createdBy: currentUser.uid,
          assignedTo: null,
          assignedEmail: null,
          assignedAt: null
        });

        errorHandler.showSuccess(`Referral code created: ${code}`);

        // Copy to clipboard
        if (navigator.clipboard) {
          await navigator.clipboard.writeText(code);
          errorHandler.showInfo('Code copied to clipboard!');
        }

        // Reload God data to update statistics
        await loadGodData();

      } catch (error) {
        console.error('[Home] Error generating referral code:', error);
        errorHandler.handleFirebaseError(error, 'generateReferralCode');
      }
    };

    window.viewReferralCodes = async function() {
      try {
        const referralCodesSnapshot = await db.collection('referralCodes').get();

        if (referralCodesSnapshot.empty) {
          errorHandler.showInfo('No referral codes found. Generate one first!');
          return;
        }

        const codes = [];
        referralCodesSnapshot.forEach(doc => {
          const data = doc.data();
          codes.push({
            code: doc.id,
            used: data.used || false,
            createdAt: data.createdAt,
            assignedEmail: data.assignedEmail,
            assignedName: data.assignedName,
            usedAt: data.usedAt  // Fixed: was assignedAt, now usedAt to match login.html
          });
        });

        // Sort by creation date (newest first)
        codes.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
        });

        // Build table view
        let message = 'üé´ REFERRAL CODES\n\n';
        message += '‚ïê'.repeat(60) + '\n\n';

        const unusedCodes = codes.filter(c => !c.used);
        const usedCodes = codes.filter(c => c.used);

        if (unusedCodes.length > 0) {
          message += '‚úÖ AVAILABLE CODES:\n\n';
          unusedCodes.forEach(c => {
            const createdDate = new Date(c.createdAt).toLocaleDateString();
            message += `  ${c.code} - Created: ${createdDate}\n`;
          });
          message += '\n';
        }

        if (usedCodes.length > 0) {
          message += '‚ùå USED CODES:\n\n';
          usedCodes.forEach(c => {
            const usedDate = c.usedAt ? new Date(c.usedAt).toLocaleDateString() : 'No date';
            const userName = c.assignedName || c.assignedEmail || 'Unknown';
            message += `  ${c.code} - Used by: ${userName} (${usedDate})\n`;
          });
        }

        message += '\n‚ïê'.repeat(60) + '\n';
        message += `Total: ${codes.length} | Available: ${unusedCodes.length} | Used: ${usedCodes.length}`;

        // Show custom modal instead of alert
        showReferralCodesModal(codes);

      } catch (error) {
        console.error('[Home] Error viewing referral codes:', error);
        errorHandler.handleFirebaseError(error, 'viewReferralCodes');
      }
    };

    // Show custom modal with referral codes
    function showReferralCodesModal(codes) {
      const unusedCodes = codes.filter(c => !c.used);
      const usedCodes = codes.filter(c => c.used);

      let html = '<div class="codes-grid">';

      // Available codes section
      if (unusedCodes.length > 0) {
        html += '<div class="code-section">';
        html += '<h3>‚úÖ Available Codes <span style="font-size: 0.75rem; opacity: 0.7; font-weight: normal;">(Click to copy URL)</span></h3>';
        unusedCodes.forEach(c => {
          const createdDate = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : 'Unknown';
          html += `
            <div class="code-item clickable-code" onclick="copyReferralUrl('${c.code}')" style="cursor: pointer;" title="Click to copy referral URL">
              <div class="code-item-header">
                <span class="code-value">${c.code}</span>
                <span class="code-status available">Available</span>
              </div>
              <div class="code-details">
                Created: ${createdDate}<br>
                <span style="color: #00d4ff; font-size: 0.8rem;">üìã Click to copy URL</span>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // Used codes section
      if (usedCodes.length > 0) {
        html += '<div class="code-section">';
        html += '<h3>‚ùå Used Codes</h3>';
        usedCodes.forEach(c => {
          const usedDate = c.usedAt ? new Date(c.usedAt).toLocaleDateString() : 'No date';
          const userName = c.assignedName || c.assignedEmail || 'Unknown';
          const createdDate = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : 'Unknown';
          html += `
            <div class="code-item">
              <div class="code-item-header">
                <span class="code-value">${c.code}</span>
                <span class="code-status used">Used</span>
              </div>
              <div class="code-details">
                Used by: <strong>${userName}</strong><br>
                Used on: ${usedDate}<br>
                Created: ${createdDate}
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      html += '</div>';

      // Update modal content
      document.getElementById('referralCodesContent').innerHTML = html;
      document.getElementById('modalFooterStats').textContent =
        `Total: ${codes.length} | Available: ${unusedCodes.length} | Used: ${usedCodes.length}`;

      // Show modal
      document.getElementById('referralCodesModal').classList.add('active');
    }

    // Copy referral URL to clipboard
    window.copyReferralUrl = async function(code) {
      try {
        // Get current domain
        const protocol = window.location.protocol;
        const host = window.location.host;
        const referralUrl = `${protocol}//${host}/BoardGame/login.html?referralCode=${code}`;

        // Copy to clipboard
        await navigator.clipboard.writeText(referralUrl);

        // Visual feedback - add copied class
        const codeElements = document.querySelectorAll('.clickable-code');
        codeElements.forEach(el => {
          if (el.onclick.toString().includes(code)) {
            el.classList.add('copied');
            setTimeout(() => {
              el.classList.remove('copied');
            }, 500);
          }
        });

        // Show success message
        errorHandler.showSuccess(`Referral URL copied to clipboard!\n${referralUrl}`);

      } catch (error) {
        console.error('[Home] Error copying referral URL:', error);

        // Fallback - show the URL in a prompt
        const protocol = window.location.protocol;
        const host = window.location.host;
        const referralUrl = `${protocol}//${host}/BoardGame/login.html?referralCode=${code}`;

        prompt('Copy this referral URL:', referralUrl);
      }
    };

    // Close modal
    window.closeReferralCodesModal = function(event) {
      if (!event || event.target.classList.contains('custom-modal-overlay')) {
        document.getElementById('referralCodesModal').classList.remove('active');
      }
    };
  </script>
</body>
</html>
